<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />

		<title></title>
		<script src="${request.contextPath}/js/jquery-1.12.3.js"></script>

		<script src="${request.contextPath}/bootstrap-3.3.7/js/bootstrap.min.js"></script>

		<script src="${request.contextPath}/js/kendo.all.js"></script>
		<script src="${request.contextPath}/css/layout/js/jquery.slimscroll.min.js" type="text/javascript"></script>
		<script src="${request.contextPath}/css/layout/js/app.js" type="text/javascript"></script>
		<script src="${request.contextPath}/css/layout/js/bootbox.min.js" type="text/javascript"></script>
		<script src="${request.contextPath}/css/layout/js/layout.min.js" type="text/javascript"></script>
		<script src="${request.contextPath}/js/kendo.hap.js"></script>
		<link rel="stylesheet" href="${request.contextPath}/css/kendo.common.min.css" />
		<link rel="stylesheet" href="${request.contextPath}/bootstrap-3.3.7/css/bootstrap.css" />
		<link rel="stylesheet" href="${request.contextPath}/css/font-awesome-4.6.3/css/font-awesome.min.css" />
	    <link rel="stylesheet" href="${request.contextPath}/css/kendo.common-bootstrap.min.css" />
	    <link rel="stylesheet" href="${request.contextPath}/css/kendo.material.min.css" />
	    <link rel="stylesheet" href="${request.contextPath}/css/kendo.uniform.min.css"/>
		<link rel="stylesheet" href="${request.contextPath}/css/layout/layout.css"/>
		<link rel="stylesheet" href="${request.contextPath}/css/layout/custom.css"/>
		<link rel="stylesheet" href="${request.contextPath}/css/layout/themes/default.css"/>

	</head>

	<style type="text/css">
		.nav > li > a:focus, .nav > li > a:hover {
			background-color: inherit !important;
		}
		.nav > li > a:focus, .nav > li > a:hover {
			background-color: inherit !important;
		}
		#mainTab .k-tabstrip-items li{
			position: relative;
			display: inline-block;
			cursor: pointer;
			height: auto !important;
			min-width:70px;
			text-align:center;
		}
		#mainTab .k-tabstrip-items li span.k-link{
			background: 0 0!important;
			border: 0;
			margin: 0;
			color: #678098;
			display: block;
			padding: 10px 20px;
		}

		#mainTab .k-tabstrip-items li:hover{
			background-color: #f2f6f9;
			border-top: 3px solid #f2f6f9 !important;
		}

		#mainTab .k-tabstrip-items li:hover span.k-link{
			color: #5b9bd1;
		}

		#mainTab .k-tabstrip-items li.k-state-active{
			background: 0 0;
			margin: 0;
			position: relative;
			background-color: #e9ecf3;
			cursor: default;
			border-top: 3px solid #5C9ACF!important;
			border-bottom-color: transparent;
			height: auto !important;
		}

		#mainTab .k-tabstrip-items li.k-state-active span.k-link{
			color: #5b9bd1;
			display: block;
			padding: 10px 20px;
		}


		#mainTab .k-tabstrip-items{
			width: 100%;
			/*  border-bottom: 1px solid #ddd;*/
			margin: 0px !important;
			background-color: #fff;
			list-style-type: none;
			position: relative;
			/* vertical-align: top;*/
			white-space: nowrap;
			padding: 0px;
			overflow: hidden;
		}

		#tabstrip-parent, #tabstrip {
			height: 100%;
			margin: 0;
			padding: 0;
			border-width: 0;
		}

		#mainTab >.k-content{
			margin: 0;
			padding: 0;
			overflow:hidden;
		}

		#mainTab .k-tabstrip-items .k-state-default.k-state-hover .k-i-close{
			visibility: visible;
		}

		#mainTab .k-tabstrip-prev,#mainTab .k-tabstrip-next {
			top:2px;
			background-color:#fff !important;
			display: inline-block !important;
		}

		#mainTab .k-i-arrow-w:hover,.k-i-arrow-e:hover{
			color: #36c6d3;
		}

		#mainTab .k-i-arrow-w {
			position: absolute;
			background-color: #fff;
			text-align: center;
		}
		#mainTab .k-i-arrow-e{
			position: absolute;
			background-color: #fff;
			text-align: center;
		}

		.k-tabstrip-wrapper .k-content iframe{
			height:100%;
			width:100%;
			padding:0px;
		}

		.page-content{
			position: relative;
		}

		.tabstrip-context-menu{
			list-style-type: none;
			padding: 5px 15px;
			font-size: 14px !important;
			background:#fff;padding: 7px 0px;
			font-size: 12px !important;
			cursor: pointer;
			border: 1px solid #efefef;
			background-color: #fff;
		}
		.tabstrip-context-menu .k-item{
			height: 22px;
			width: 140px;
			line-height: 22px;
		}
		.tabstrip-context-menu .k-item:hover{
			background-color: #f2f6f9;
		}
		.tabstrip-context-menu .k-item .k-link{
			padding:0px 42px 0px 25px;
		}
		.page-content-main{
			background: 0 0;
		}
		.title.point::before{
			content: " ";
			border: 3px solid red;/*设置红色*/
			border-radius:3px;/*设置圆角*/
			position: absolute;
			z-index: 1000;
			right: 0%;
			margin-right: -5px;
			margin-top: -5px;
		}
	</style>

	<body class="page-container-bg-solid page-header-fixed page-sidebar-closed-hide-logo page-sidebar-fixed">

	<div class="page-header navbar navbar-fixed-top">
		<div class="page-header-inner ">
			<div class="page-logo">
				<a href="index.html">

					<span class="page-title">${SYS_TITLE!'Application Redandelion'}</span>
				</a>
				<div class="menu-toggler sidebar-toggler"></div>
			</div>
			<a href="javascript:;" class="menu-toggler responsive-toggler" data-toggle="collapse" data-target=".navbar-collapse"> </a>
			<div id="page-nav" class="page-actions" style="display: none">
				<div class="btn-group">
					<button type="button" class="btn red-haze btn-sm dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
						<span class="hidden-sm hidden-xs"> &nbsp;</span>
						<i class="fa fa-angle-down"></i>
					</button>
					<ul class="dropdown-menu" id="tabstrip-menu" role="menu"></ul>
				</div>
			</div>
			<div class="page-top">
				<div class="top-menu">
					<ul class="nav navbar-nav pull-right">
						<li class="dropdown dropdown-user dropdown-dark">
							<a href="${request.contextPath}/sys/sys_shortcut.html"
							   title=""
							   style="height: 75px;padding: 28px 10px 18px;" data-target="#long"
							   data-toggle="modal">
								<i class="fa fa-television" style="color: #aeb2c4;"></i>
								<span class="username username-hide-on-mobile" style="color: #aeb2c4;"></span>
							</a>
						</li>
						<#if rer??>
							<li id="AShortcut" class="dropdown dropdown-user dropdown-dark" style="display: none">
								<a href="javascript:;" class="dropdown-toggle" data-toggle="dropdown"
								   data-hover="dropdown" data-close-others="true">
                                    <span class="username username-hide-on-mobile"
										  style="height: 30px;padding-top: 4px;"></span></a>
								<ul class="dropdown-menu dropdown-menu-default">
									<#list SYS_USER_ROLES as roles>
										<li>
											<#if roles.roleId == CURRENT_USER_ROLE>
												<a href="javascript:;">
													<i class="icon-user" style="color: #3598dc"></i>
													<#else>
														<a href="${request.contextPath}/sys/role/change?roleId=${roles.roleId}">
															<i class="icon-user"></i>
											</#if>
											${roles.roleName}!'redandelion'</a>
										</li>
									</#list>
								</ul>
							</li>
						</#if>

						<li class="dropdown dropdown-user dropdown-dark">
							<a href="javascript:;" class="dropdown-toggle" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
								<span class="username username-hide-on-mobile"></span>
								<!--<img alt="" class="img-circle" src="${request.contextPath}/lib/assets/layouts/layout4/img/avatar9.jpg" /> </a>-->
							<ul class="dropdown-menu dropdown-menu-default">
								<li>
									<a href="javascript:myProfile();">
										<i class="icon-user"></i>

									</a>
								</li>
								<li>
									<a href="javascript:sysPreferences();">
										<i class="fa fa-cogs"></i>

									</a>
								</li>
								<li class="divider"> </li>
								<li>
									<a href="javascript:logout();">
										<i class="icon-key"></i>

									</a>
								</li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="long" role="basic" style="padding-top: 110px">
		<div class="modal-dialog">
			<div class="modal-content" style="width: 700px; height:550px">
				<div class="modal-body">
					<div id="page-content"></div>
				</div>
			</div>
		</div>
	</div>

	<div id="static" class="modal fade" tabindex="-1" data-backdrop="static" data-keyboard="false">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
					<h4 class="modal-title">确认框</h4>
				</div>
				<div class="modal-body">
					<p> 添入成功</p>
				</div>
				<div class="modal-footer">
					<button type="button" data-dismiss="modal" class="btn dark btn-outline">Cancel</button>
					<button type="button" data-dismiss="modal" class="btn green">Continue Task</button>
				</div>
			</div>
		</div>
	</div>

	<div class="clearfix"></div>
	<div class="page-container">
		<div class="page-sidebar-wrapper">
			<div class="page-sidebar navbar-collapse collapse">
				<ul id="page-sidebar-menu" class="page-sidebar-menu" data-keep-expanded="false" data-auto-scroll="false" data-slide-speed="200"></ul>
			</div>
		</div>

		<div class="page-content-wrapper">
			<div class="page-content">
				<div class="page-head"  style="display: none">
					<div class="page-title" style="display: inline-block">
						<h1 id="page-title"></h1>
					</div>
					<div class="page-toolbar">
						<div class="btn-group pull-right">
							<button type="button" data-close-others="true" class="btn green btn-sm btn-outline dropdown-toggle" data-toggle="dropdown">

								<i class="fa fa-angle-down"></i>
							</button>
							<ul class="dropdown-menu pull-right" id="page-button" role="menu" style="min-width: 135px">
							</ul>
						</div>
					</div>
				</div>
				<div class="page-content-main">
					<div id="page-content-loading">
						<i class="fa fa-refresh fa-spin"></i>
						<span></span>
					</div>

					<div id="mainTab" style="position:absolute;left:-10000px;top:-10000px;outline: 0 !important;"></div>
				</div>
			</div>
		</div>
	</div>
	<script src="${request.contextPath}/js/kendo.all.js"></script>
	<script src="${request.contextPath}/js/kendo.culture.zh-CN.js"></script>
	<script src="${request.contextPath}/js/kendo.messages.zh-CN.js"></script>
	<script>

    var menuItems = [];
//    加载菜单
	function loadMenu(){
	$.ajax({
		type: 'GET',
		url: '${request.contextPath}/sys/rolemenu',
		contentType: "application/json; charset=utf-8",
		success: function (data) {
		var html=['<li class="nav-item start active"><a id="link_home" href="javascript:openTab(\'home\',\'"主页"\', \'home.html\');" class="nav-link"><i class="icon-home"></i><span class="title">主页</span></a></li>'];

		datas = [].concat(data.rows);
		console.log(datas);
		createMenu(html,datas, true);
		$("#page-sidebar-menu").append(html.join(''));
		menuItems = convertToLine(datas);
		}
		});
	}
//	创建菜单
    function createMenu(html,datas, top){
        for(var i=0;i<datas.length;i++){
            var data = datas[i];
            html.push('<li class="nav-item">');
            if(data.children){
                html.push('<a href="javascript:;" class="nav-link">');
                html.push('<i class="'+(data.icon||'fa fa-cube')+'"></i>');
                // if(top){
                html.push('<span class="title">' + data.text + '</span>');
                // }else {
                //  html.push(data.text);
                //  }
                html.push('<span class="arrow"></span></a><ul class="sub-menu">');
                createMenu(html,data.children);
                html.push('</ul>')
            } else if(data.url){
                html.push('<a class="nav-link" id="link_'+data.functionCode+'" href="javascript:openTab(\''+data.functionCode+'\',\''+data.text+'\', \''+data.url+'\')">');
                html.push('<i class="'+(data.icon||'')+'"></i>');
                html.push('<span class="title">' + data.text + '</span>');
                html.push('</a>')
            }
            html.push('</li>')
        }
    }

    var menuItems = [];
    //将tree形的数据转换成线形数据
    function convertToLine(datas){
        var arr=[];
        function build(d){
            if (d.children) {
                $.each(d.children,function(i,r){
                    build(r);
                });
            }else{
                //将数据转换使实现text和code双查询
                d.codeAndText=d.functionCode+d.text;
                arr.push(d);
            }
        }
        $.each(datas,function(i,r){
            build(r);
        });

        arr.push({
            functionCode:"MY_PROFILE",
            icon:"icon-user",
            text:'用户信息',
            url:"${request.contextPath}/sys/um/sys_user_info.html"
        })
        arr.push({
            functionCode:"SYS_PREFERENCE",
            icon:"icon-user",
            text:'系统配置',
            url:"${request.contextPath}/sys/um/sys_preferences.html"
        })
        return arr;
    }
    function showTabLoading(show){
        $('#page-content-loading')[show ? 'show' : 'hide']();
        if(show){
            $("#mainTab").css({
                'position':'absolute',
                'left':'-10000px',
                'top':'-10000px'
            })
        }else{
            $("#mainTab").css({
                'position':'static',
                'left':'0px',
                'top':'0px'
            })
        }
    }
    var isInitScroller = false;
    var isChangeWidth = false;
    function scrollerInit(){
        var e = $("#mainTab").find(".k-i-arrow-e .fa-chevron-right");
        var w = $("#mainTab").find(".k-i-arrow-w .fa-chevron-left");
        var height = $('#mainTab .k-tabstrip-items').outerHeight();
        var position = $('#mainTab .k-tabstrip-items').position();
        if(!e.length){
            $("#mainTab").find(".k-i-arrow-e").append('<i class="fa fa-chevron-right" aria-hidden="true"></i>');
            $("#mainTab").find(".k-i-arrow-e").css({
                top:position.top||0,
                right:position.right||0,
                height:height+"px",
                lineHeight:height+"px",
                width:'5%'
            })
        }
        if(!w.length){
            $("#mainTab").find(".k-i-arrow-w").append('<i class="fa fa-chevron-left" aria-hidden="true"></i>');
            var width = $('.page-content').outerWidth()-$('#mainTab').outerWidth()+2;
            $("#mainTab").find(".k-i-arrow-w").css({
                top:position.top||0,
                left:position.left||0,
                lineHeight:height+"px",
                height:height+"px",
                width:'5%'
            })
        }
    }

    function initTabStripItems(obj){
        var hasScroller = $("#mainTab").hasClass("k-tabstrip-scrollable");

        if(!isInitScroller && hasScroller ){
            scrollerInit();
            $("#mainTab .k-tabstrip-items").css("cssText", "display:inline-block;width:90% !important;margin-left:5% !important;");                isInitScroller = true;
            isChangeWidth = false;
        }
        if(!isChangeWidth && !hasScroller){
            $("#mainTab .k-tabstrip-items").css("cssText", "display:inline-block;width:100% !important;margin:0% !important;");                isInitScroller = false;
            isChangeWidth = true;
        }

        if(!$(obj.item).find(".arrow.close").length){
            $(obj.item).find(".k-icon.k-i-close").append('<span class="arrow close" style="margin: 5px 5px;position: absolute;display: none"></span>');            }

        $("#mainTab .k-tabstrip-items li").off("mouseover").off("mouseout").on({
            "mouseover":function (e) {
                $(e.currentTarget).find(".arrow.close").css("display","inline-block");
            },
            "mouseout":function (e) {
                $(e.currentTarget).find(".arrow.close").css("display","none");
            }
        });
    }

    function initTabList(){
        var mainTab = $("#mainTab").data("kendoTabStrip");
        var html=[];
        $.each(mainTab.items(),function(i,v){
            var tabid = $(v).find("span.k-link").attr("data-tabid");
            if( tabid == "home"){
//                html.push('<li><a href="javascript:openTab(\'home\',\'首页\',\'home.html\')"><span style="padding-right:20px;" ><i class="icon-home"   style=" margin-right: 10px;" ></i>'+v.textContent+"</span></a></li>");
            }else{
                var data = findByCode(tabid);
                if(!data) {
                    data = {
                        icon:'fa fa-file',
                        functionCode: tabid,
                        text: v.innerText,
                        url: ''
                    }
                }
                html.push('<li><a href="javascript:;openTab(\''+data.functionCode+'\',\''+data.text+'\', \''+data.url+'\')">');
                html.push('<span style="margin-right:10px;display:block"><i  style=" margin-right: 10px;" class="'+(data.icon||'')+'"></i>'+v.textContent+'</span>')
                html.push('<span data-tabid='+tabid+' class="badge badge-danger close-btn">X</span></a></li>');

            }
        });
        $("#tabstrip-menu").html(html.join(''));
    }
    function closeTab(id){
        $("#mainTab").data("kendoTabStrip").closeTab(id);
    }
    $('#tabstrip-menu').on("click",'.close-btn', function(event){
        event.preventDefault();
        event.stopPropagation();
        var tabid = $(event.target).data("tabid");
        $("#mainTab").data("kendoTabStrip").closeTab(tabid);

    });
    function init(){
        loadMenu();
        $("#mainTab").kendoTabStrip({
            height:'100%',
            animation:  false,
            closeIcon : true,
            contextMenu : true,
            refresh:function(){
                showTabLoading(true);
            },
            load:function(para){
                var iframe = para.iframe[0];
                window.autoResizeIframe(iframe.name)
                showTabLoading(false);
            },
            activate:function(obj){
                $('#page-title').html(obj.item.innerText);
                var id = $(obj.item).find('.k-link').data('tabid');
                var html=[];
                html.push('<li> <a href="javascript:;"  id="page-refresh-button" onclick="refreshPage(this)"><i class="icon-refresh"></i> refresh </a> </li>');

                if(id!="home"){
//                    html.push('<li> <a href="javascript:;"  id="page-addshortCut-button" onclick="addShortcut(\'' + id + '\')"><i class="fa fa-plus-square"></i>  </a> </li>');
//                    html.push('<li><a href="javascript:;" id="page-close-button" onclick="closePage(this)" ><i class="icon-close"></i>  log out</a></li>');
                }
                $("#page-button").html(html.join(''));
                $("#page-close-button").data("tabid",id);
                $("#page-refresh-button").data("tabid",id);
                $('#page-sidebar-menu').find('li.active').removeClass('active');
                $('#link_'+id).parents('li.nav-item').addClass('active');
                if(nav == "Y"){
                    initTabStripItems(obj);
                }else{
                    initTabList();
                }

            },
            close:function(){
                if(nav != "Y"){
                    initTabList();
                }
            }

        }).data("kendoTabStrip");
        $("#mainTab").parent().attr("id", "tabstrip-parent");
//        openTab('home', '', 'home.html', false);
        if(nav=="Y"){
            $("#mainTab .k-tabstrip-items").css("display","inline-block");
            $("#AShortcut").css("display","block");
        }else{
            $(".page-content-wrapper .page-content .page-head").css("display","block");
            $("#AShortcut").css("display","block");
            $("#page-nav").css("display","block");
        }

    }
    init();
    var viewHeight = $(window).height(), contentHeight = viewHeight - 159;
    function autoResizeIframe(id, height, callback){
        setTimeout(function(){
            var iframe = $('#iframe_'+id)[0];
            if(iframe != null && iframe.contentDocument != null) {
                var subWeb = iframe.contentDocument;
                $(iframe).height(Math.max(Math.max(subWeb.body.clientHeight, contentHeight), height||0));
            }
            if(callback) callback.call(window)
        }, 50)

    }
//    loadMenu();



    function findByCode(functionCode){
        var data= null;
        for(var i=0;i<menuItems.length;i++)
        {
            if(menuItems[i].functionCode == functionCode){
                data = menuItems[i];
                break;
            }
        }
        return data;
    }
    var nav = 0;
    function openTab(id,title,url, closeIcon){
        var mainTab = $("#mainTab").data("kendoTabStrip");
        $('html,body').animate({
            scrollTop: 0
        }, 'fast');
        if(nav != "Y"){
            if($.inArray(id, mainTab.tabids) == -1){
                this.showTabLoading(true)
            }
        }

//        if(url.indexOf('?') == -1){
//            url += '?functionCode=' + id;
//        }else{
//            url += '&functionCode=' + id;
//        }

        mainTab.append({
            text : title,
            tabid : id,
            contentIframe : url,
            closeIcon: closeIcon = closeIcon === undefined ? true : closeIcon,
            encoded: false
        });
        if(nav == "Y"){
            $('#mainTab').children(".k-state-active");
        }
    }


//	初始化

	</script>
	</body>
</html>
